var G=Object.create;var b=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var $=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var B=(t,l)=>()=>(l||t((l={exports:{}}).exports,l),l.exports),Y=(t,l)=>{for(var c in l)b(t,c,{get:l[c],enumerable:!0})},T=(t,l,c,o)=>{if(l&&typeof l=="object"||typeof l=="function")for(let s of F(l))!q.call(t,s)&&s!==c&&b(t,s,{get:()=>l[s],enumerable:!(o=V(l,s))||o.enumerable});return t};var P=(t,l,c)=>(c=t!=null?G($(t)):{},T(l||!t||!t.__esModule?b(c,"default",{value:t,enumerable:!0}):c,t)),H=t=>T(b({},"__esModule",{value:!0}),t);var O=B((ae,N)=>{"use strict";var S=global;S.crypto||(S.crypto=require("crypto"));var X=S.crypto;(()=>{let t=()=>{let o=new Error("not implemented");return o.code="ENOSYS",o};if(!globalThis.fs){let o="";globalThis.fs={constants:{O_WRONLY:-1,O_RDWR:-1,O_CREAT:-1,O_TRUNC:-1,O_APPEND:-1,O_EXCL:-1},writeSync(s,n){o+=c.decode(n);let i=o.lastIndexOf(`
`);return i!=-1&&(console.log(o.substring(0,i)),o=o.substring(i+1)),n.length},write(s,n,i,a,u,g){if(i!==0||a!==n.length||u!==null){g(t());return}let m=this.writeSync(s,n);g(null,m)},chmod(s,n,i){i(t())},chown(s,n,i,a){a(t())},close(s,n){n(t())},fchmod(s,n,i){i(t())},fchown(s,n,i,a){a(t())},fstat(s,n){n(t())},fsync(s,n){n(null)},ftruncate(s,n,i){i(t())},lchown(s,n,i,a){a(t())},link(s,n,i){i(t())},lstat(s,n){n(t())},mkdir(s,n,i){i(t())},open(s,n,i,a){a(t())},read(s,n,i,a,u,g){g(t())},readdir(s,n){n(t())},readlink(s,n){n(t())},rename(s,n,i){i(t())},rmdir(s,n){n(t())},stat(s,n){n(t())},symlink(s,n,i){i(t())},truncate(s,n,i){i(t())},unlink(s,n){n(t())},utimes(s,n,i,a){a(t())}}}if(globalThis.process||(globalThis.process={getuid(){return-1},getgid(){return-1},geteuid(){return-1},getegid(){return-1},getgroups(){throw t()},pid:-1,ppid:-1,umask(){throw t()},cwd(){throw t()},chdir(){throw t()}}),!globalThis.crypto)throw new Error("globalThis.crypto is not available, polyfill required (crypto.getRandomValues only)");if(!globalThis.performance)throw new Error("globalThis.performance is not available, polyfill required (performance.now only)");if(!globalThis.TextEncoder)throw new Error("globalThis.TextEncoder is not available, polyfill required");if(!globalThis.TextDecoder)throw new Error("globalThis.TextDecoder is not available, polyfill required");let l=new TextEncoder("utf-8"),c=new TextDecoder("utf-8");globalThis.Go=class{constructor(){this.argv=["js"],this.env={},this.exit=e=>{e!==0&&console.warn("exit code:",e)},this._exitPromise=new Promise(e=>{this._resolveExitPromise=e}),this._pendingEvent=null,this._scheduledTimeouts=new Map,this._nextCallbackTimeoutID=1;let o=(e,r)=>{this.mem.setUint32(e+0,r,!0),this.mem.setUint32(e+4,Math.floor(r/4294967296),!0)},s=(e,r)=>{this.mem.setUint32(e+0,r,!0)},n=e=>{let r=this.mem.getUint32(e+0,!0),d=this.mem.getInt32(e+4,!0);return r+d*4294967296},i=e=>{let r=this.mem.getFloat64(e,!0);if(r===0)return;if(!isNaN(r))return r;let d=this.mem.getUint32(e,!0);return this._values[d]},a=(e,r)=>{if(typeof r=="number"&&r!==0){if(isNaN(r)){this.mem.setUint32(e+4,2146959360,!0),this.mem.setUint32(e,0,!0);return}this.mem.setFloat64(e,r,!0);return}if(r===void 0){this.mem.setFloat64(e,0,!0);return}let h=this._ids.get(r);h===void 0&&(h=this._idPool.pop(),h===void 0&&(h=this._values.length),this._values[h]=r,this._goRefCounts[h]=0,this._ids.set(r,h)),this._goRefCounts[h]++;let y=0;switch(typeof r){case"object":r!==null&&(y=1);break;case"string":y=2;break;case"symbol":y=3;break;case"function":y=4;break}this.mem.setUint32(e+4,2146959360|y,!0),this.mem.setUint32(e,h,!0)},u=e=>{let r=n(e+0),d=n(e+8);return new Uint8Array(this._inst.exports.mem.buffer,r,d)},g=e=>{let r=n(e+0),d=n(e+8),h=new Array(d);for(let y=0;y<d;y++)h[y]=i(r+y*8);return h},m=e=>{let r=n(e+0),d=n(e+8);return c.decode(new DataView(this._inst.exports.mem.buffer,r,d))},f=Date.now()-performance.now();this.importObject={_gotest:{add:(e,r)=>e+r},gojs:{"runtime.wasmExit":e=>{e>>>=0;let r=this.mem.getInt32(e+8,!0);this.exited=!0,delete this._inst,delete this._values,delete this._goRefCounts,delete this._ids,delete this._idPool,this.exit(r)},"runtime.wasmWrite":e=>{e>>>=0;let r=n(e+8),d=n(e+16),h=this.mem.getInt32(e+24,!0);fs.writeSync(r,new Uint8Array(this._inst.exports.mem.buffer,d,h))},"runtime.resetMemoryDataView":e=>{e>>>=0,this.mem=new DataView(this._inst.exports.mem.buffer)},"runtime.nanotime1":e=>{e>>>=0,o(e+8,(f+performance.now())*1e6)},"runtime.walltime":e=>{e>>>=0;let r=new Date().getTime();o(e+8,r/1e3),this.mem.setInt32(e+16,r%1e3*1e6,!0)},"runtime.scheduleTimeoutEvent":e=>{e>>>=0;let r=this._nextCallbackTimeoutID;this._nextCallbackTimeoutID++,this._scheduledTimeouts.set(r,setTimeout(()=>{for(this._resume();this._scheduledTimeouts.has(r);)console.warn("scheduleTimeoutEvent: missed timeout event"),this._resume()},n(e+8))),this.mem.setInt32(e+16,r,!0)},"runtime.clearTimeoutEvent":e=>{e>>>=0;let r=this.mem.getInt32(e+8,!0);clearTimeout(this._scheduledTimeouts.get(r)),this._scheduledTimeouts.delete(r)},"runtime.getRandomData":e=>{e>>>=0,X.getRandomValues(u(e+8))},"syscall/js.finalizeRef":e=>{e>>>=0;let r=this.mem.getUint32(e+8,!0);if(this._goRefCounts[r]--,this._goRefCounts[r]===0){let d=this._values[r];this._values[r]=null,this._ids.delete(d),this._idPool.push(r)}},"syscall/js.stringVal":e=>{e>>>=0,a(e+24,m(e+8))},"syscall/js.valueGet":e=>{e>>>=0;let r=Reflect.get(i(e+8),m(e+16));e=this._inst.exports.getsp()>>>0,a(e+32,r)},"syscall/js.valueSet":e=>{e>>>=0,Reflect.set(i(e+8),m(e+16),i(e+32))},"syscall/js.valueDelete":e=>{e>>>=0,Reflect.deleteProperty(i(e+8),m(e+16))},"syscall/js.valueIndex":e=>{e>>>=0,a(e+24,Reflect.get(i(e+8),n(e+16)))},"syscall/js.valueSetIndex":e=>{e>>>=0,Reflect.set(i(e+8),n(e+16),i(e+24))},"syscall/js.valueCall":e=>{e>>>=0;try{let r=i(e+8),d=Reflect.get(r,m(e+16)),h=g(e+32),y=Reflect.apply(d,r,h);e=this._inst.exports.getsp()>>>0,a(e+56,y),this.mem.setUint8(e+64,1)}catch(r){e=this._inst.exports.getsp()>>>0,a(e+56,r),this.mem.setUint8(e+64,0)}},"syscall/js.valueInvoke":e=>{e>>>=0;try{let r=i(e+8),d=g(e+16),h=Reflect.apply(r,void 0,d);e=this._inst.exports.getsp()>>>0,a(e+40,h),this.mem.setUint8(e+48,1)}catch(r){e=this._inst.exports.getsp()>>>0,a(e+40,r),this.mem.setUint8(e+48,0)}},"syscall/js.valueNew":e=>{e>>>=0;try{let r=i(e+8),d=g(e+16),h=Reflect.construct(r,d);e=this._inst.exports.getsp()>>>0,a(e+40,h),this.mem.setUint8(e+48,1)}catch(r){e=this._inst.exports.getsp()>>>0,a(e+40,r),this.mem.setUint8(e+48,0)}},"syscall/js.valueLength":e=>{e>>>=0,o(e+16,parseInt(i(e+8).length))},"syscall/js.valuePrepareString":e=>{e>>>=0;let r=l.encode(String(i(e+8)));a(e+16,r),o(e+24,r.length)},"syscall/js.valueLoadString":e=>{e>>>=0;let r=i(e+8);u(e+16).set(r)},"syscall/js.valueInstanceOf":e=>{e>>>=0,this.mem.setUint8(e+24,i(e+8)instanceof i(e+16)?1:0)},"syscall/js.copyBytesToGo":e=>{e>>>=0;let r=u(e+8),d=i(e+32);if(!(d instanceof Uint8Array||d instanceof Uint8ClampedArray)){this.mem.setUint8(e+48,0);return}let h=d.subarray(0,r.length);r.set(h),o(e+40,h.length),this.mem.setUint8(e+48,1)},"syscall/js.copyBytesToJS":e=>{e>>>=0;let r=i(e+8),d=u(e+16);if(!(r instanceof Uint8Array||r instanceof Uint8ClampedArray)){this.mem.setUint8(e+48,0);return}let h=d.subarray(0,r.length);r.set(h),o(e+40,h.length),this.mem.setUint8(e+48,1)},debug:e=>{console.log(e)}}}}async run(o){if(!(o instanceof WebAssembly.Instance))throw new Error("Go.run: WebAssembly.Instance expected");this._inst=o,this.mem=new DataView(this._inst.exports.mem.buffer),this._values=[NaN,0,null,!0,!1,globalThis,this],this._goRefCounts=new Array(this._values.length).fill(1/0),this._ids=new Map([[0,1],[null,2],[!0,3],[!1,4],[globalThis,5],[this,6]]),this._idPool=[],this.exited=!1;let s=4096,n=f=>{let e=s,r=l.encode(f+"\0");return new Uint8Array(this.mem.buffer,s,r.length).set(r),s+=r.length,s%8!==0&&(s+=8-s%8),e},i=this.argv.length,a=[];this.argv.forEach(f=>{a.push(n(f))}),a.push(0),Object.keys(this.env).sort().forEach(f=>{a.push(n(`${f}=${this.env[f]}`))}),a.push(0);let g=s;if(a.forEach(f=>{this.mem.setUint32(s,f,!0),this.mem.setUint32(s+4,0,!0),s+=8}),s>=12288)throw new Error("total length of command line and environment variables exceeds limit");this._inst.exports.run(i,g),this.exited&&this._resolveExitPromise(),await this._exitPromise}_resume(){if(this.exited)throw new Error("Go program has already exited");this._inst.exports.resume(),this.exited&&this._resolveExitPromise()}_makeFuncWrapper(o){let s=this;return function(){let n={id:o,this:this,args:arguments};return s._pendingEvent=n,s._resume(),n.result}}}})();N.exports={globalThisCopy:S}});var se={};Y(se,{handleMessage:()=>te});module.exports=H(se);var j=P(require("axios")),p=require("@getpara/core-sdk");var w=require("@getpara/core-sdk"),_=(t,l,c)=>`{"ServerUrl":"${t}", "WalletId": "${l}", "Id":"${c}", "Ids":["USER","CAPSULE"], "Threshold":1}`,U=(t,l,c)=>`{"walletId": "${t}", "id":"${l}", "otherId":"CAPSULE", "isReceiver": false, "disableWebSockets": ${c}}`;async function I(t,l,c,o){let{data:s}=await t.mpcComputationClient.post("/wallets",{userId:l,walletId:c,protocolId:o});return s}async function z(t,l,c,o,s,n){let{data:i}=await t.mpcComputationClient.post(`/wallets/${c}/messages/sign`,{userId:l,protocolId:o,message:s,signer:n});return i}async function v(t,l,c,o,s,n,i){let{data:a}=await t.mpcComputationClient.post(`/wallets/${c}/transactions/send`,{userId:l,protocolId:o,transaction:s,signer:n,chainId:i});return a}async function E(t,l){let{walletId:c,protocolId:o}=await t.client.createWallet(l,{scheme:w.WalletScheme.ED25519,type:w.WalletType.SOLANA}),s=(0,w.getBaseMPCNetworkUrl)(t.env,!t.disableWebSockets);return{signer:await new Promise((i,a)=>global.ed25519CreateAccount(s,c,o,(u,g)=>{u&&a(u),i(g)})),walletId:c}}async function R(t,l,c){let{walletId:o,protocolId:s}=await t.client.createPregenWallet({pregenIdentifier:l,pregenIdentifierType:c,scheme:w.WalletScheme.ED25519,type:w.WalletType.SOLANA}),n=(0,w.getBaseMPCNetworkUrl)(t.env,!t.disableWebSockets);return{signer:await new Promise((a,u)=>global.ed25519CreateAccount(n,o,s,(g,m)=>{g&&u(g),a(m)})),walletId:o}}async function k(t,l,c,o,s){let{protocolId:n}=await t.client.preSignMessage(c,o,s,w.WalletScheme.ED25519);return{signature:await new Promise((a,u)=>global.ed25519Sign(l,n,s,(g,m)=>{g&&u(g),a(m)}))}}async function A(t,l,c,o){let{walletId:s,protocolId:n}=await t.client.createWallet(l,{useTwoSigners:!0,scheme:t.useDKLS?w.WalletScheme.DKLS:w.WalletScheme.CGGMP,type:c,cosmosPrefix:c===w.WalletType.COSMOS?t.cosmosPrefix:void 0});if(t.offloadMPCComputationURL&&!t.useDKLS)return{signer:(await I(t,l,s,n)).signer,walletId:s};let i=(0,w.getBaseMPCNetworkUrl)(t.env,!t.disableWebSockets),a=t.useDKLS?U(s,"USER",t.disableWebSockets):_(i,s,"USER"),u=t.useDKLS?global.dklsCreateAccount:global.createAccountV2;return{signer:await new Promise((m,f)=>u(a,i,n,o,()=>{},(e,r)=>{e&&f(e),m(r)})),walletId:s}}async function D(t,l,c,o,s,n){let{walletId:i,protocolId:a}=await t.client.createPregenWallet({pregenIdentifier:c,pregenIdentifierType:o,type:s,cosmosPrefix:s===w.WalletType.COSMOS?t.cosmosPrefix:void 0});if(t.offloadMPCComputationURL&&!t.useDKLS)return{signer:(await I(t,l,i,a)).signer,walletId:i};let u=(0,w.getBaseMPCNetworkUrl)(t.env,!t.disableWebSockets),g=t.useDKLS?U(i,"USER",t.disableWebSockets):_(u,i,"USER"),m=t.useDKLS?global.dklsCreateAccount:global.createAccountV2;return{signer:await new Promise((e,r)=>m(g,u,a,n,()=>{},(d,h)=>{d&&r(d),e(h)})),walletId:i}}async function L(t,l,c,o,s){let{protocolId:n,pendingTransactionId:i}=await t.client.preSignMessage(o,c,s);if(i)return{pendingTransactionId:i};if(t.offloadMPCComputationURL&&!t.useDKLS)return z(t,o,c,n,s,l);let a=(0,w.getBaseMPCNetworkUrl)(t.env,!t.disableWebSockets),u=t.useDKLS?global.dklsSignMessage:global.signMessage;return new Promise((g,m)=>u(l,a,s,n,(f,e)=>{f&&m(f),g({signature:e})}))}async function W(t,l,c,o,s,n){let{data:{protocolId:i,pendingTransactionId:a}}=await t.client.signTransaction(o,c,{transaction:s,chainId:n});if(a)return{pendingTransactionId:a};if(t.offloadMPCComputationURL&&!t.useDKLS)return v(t,o,c,i,s,l,n);let u=(0,w.getBaseMPCNetworkUrl)(t.env,!t.disableWebSockets),g=t.useDKLS?global.dklsSendTransaction:global.sendTransaction;return new Promise((m,f)=>g(l,u,s,n,i,(e,r)=>{e&&f(e),m({signature:r})}))}async function K(t,l,c,o,s,n){let{data:{protocolId:i,pendingTransactionId:a}}=await t.client.sendTransaction(o,c,{transaction:s,chainId:n});if(a)return{pendingTransactionId:a};if(t.offloadMPCComputationURL&&!t.useDKLS)return v(t,o,c,i,s,l,n);let u=(0,w.getBaseMPCNetworkUrl)(t.env,!t.disableWebSockets),g=t.useDKLS?global.dklsSendTransaction:global.sendTransaction;return new Promise((m,f)=>g(l,u,s,n,i,(e,r)=>{e&&f(e),m({signature:r})}))}async function M(t,l,c,o){let{data:{protocolId:s}}=await t.client.refreshKeys(o,c),n=(0,w.getBaseMPCNetworkUrl)(t.env,!t.disableWebSockets),i=t.useDKLS?global.dklsRefresh:global.refresh;return new Promise((a,u)=>i(l,n,s,(g,m)=>{g&&u(g),a(m)}))}async function x(t,l,c,o){let s=await t.client.getParaShare(o,c);return s?new Promise((n,i)=>global.getPrivateKey(l,s,(a,u)=>{a&&i(a),n(u)})):(console.error("unable to retrieve Para share"),"")}var C;async function Q(t,l=3){for(let c=0;c<l;c++)try{return await j.default.get(`${(0,p.getPortalBaseURL)(t,!0,!0)}/static/js/main.wasm`,{responseType:"arraybuffer"})}catch(o){if(c===l-1)throw o}}async function Z(t){await Promise.resolve().then(()=>P(O())),global.WebSocket=require("ws");let l=new global.Go;C||(C=(await Q(t)).data);let c=new Uint8Array(C),o=await WebAssembly.instantiate(c,l.importObject);l.run(o.instance)}async function ee(t,l){let{functionType:c,params:o}=l;switch(c){case"KEYGEN":{let{userId:s,secretKey:n,type:i=p.WalletType.EVM}=o;return A(t,s,i,n)}case"SIGN_TRANSACTION":{let{share:s,walletId:n,userId:i,tx:a,chainId:u}=o;return W(t,s,n,i,a,u)}case"SEND_TRANSACTION":{let{share:s,walletId:n,userId:i,tx:a,chainId:u}=o;return K(t,s,n,i,a,u)}case"SIGN_MESSAGE":{let{share:s,walletId:n,userId:i,message:a}=o;return L(t,s,n,i,a)}case"REFRESH":{let{share:s,walletId:n,userId:i}=o;return M(t,s,n,i)}case"PREKEYGEN":{let{email:s,partnerId:n,secretKey:i,type:a=p.WalletType.EVM}=o,{pregenIdentifier:u,pregenIdentifierType:g}=o;return s!=="null"&&s!=="undefined"&&s!==""&&s!=null&&(u=s,g="EMAIL"),await D(t,n,u,g,a,i)}case"GET_PRIVATE_KEY":{let{share:s,walletId:n,userId:i}=o;return await x(t,s,n,i)}case"ED25519_KEYGEN":{let{userId:s}=o;return E(t,s)}case"ED25519_SIGN":{let{share:s,walletId:n,userId:i,base64Bytes:a}=o;return k(t,s,i,n,a)}case"ED25519_PREKEYGEN":{let{email:s}=o,{pregenIdentifier:n,pregenIdentifierType:i}=o;return s!=="null"&&s!=="undefined"&&s!==""&&s!=null&&(n=s,i="EMAIL"),R(t,n,i)}default:throw new Error(`functionType: ${c} not supported`)}}async function te(t){let{env:l,apiKey:c,cosmosPrefix:o="cosmos",offloadMPCComputationURL:s,disableWorkers:n,sessionCookie:i,useDKLS:a,disableWebSockets:u,workId:g}=t.data,m={env:l,apiKey:c,client:(0,p.initClient)({env:l,version:p.paraVersion,apiKey:c,retrieveSessionCookie:()=>i}),offloadMPCComputationURL:s,mpcComputationClient:s?p.mpcComputationClient.initClient(s,!!n):void 0,useDKLS:a,disableWebSockets:!!u,cosmosPrefix:o};(!m.offloadMPCComputationURL||m.useDKLS)&&await Z(m);let f=await ee(m,t.data);return f.workId=g,f}0&&(module.exports={handleMessage});
